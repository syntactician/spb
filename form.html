<!DOCTYPE html>
<html><head>
    <title>spb - Hello NSA</title>

    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="content-type" content="text/html; charset=utf-8">

    <link rel="icon" type="image/png" href="assets/favicon_32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="assets/favicon_128.png" sizes="128x128">
    <link rel="icon" type="image/png" href="assets/favicon_512.png" sizes="512x512">

    <link href="assets/pbs.css" type="text/css" rel="stylesheet">
    <link href="assets/extra.css" type="text/css" rel="stylesheet">
    <link href="assets/bootstrap-datetimepicker.css" type="text/css" rel="stylesheet">

    <script src="assets/jquery-1.js"></script>
    <script src="assets/bootstrap.js"></script>
    <script src="assets/moment.js"></script>
    <script src="assets/bootstrap-datetimepicker.js"></script>
    <script src="assets/crypto-js.js"></script>
    <script src="assets/algo.js"></script>

    <script id="index-script">var API = (function(baseurl) {

    // method, args, uri
    function request(options) {
        options = options || {};

        var url = baseurl.concat(options.uri || '');

        args = $.extend({
            url: url,
            contentType: false,
            processData: false,
            dataType: 'json',
            type: options.method
        }, options.args);

        return $.ajax(args);
    }

    function _fd(data) {
        if (FormData.prototype.isPrototypeOf(data))
            return data;

        var fd = new FormData();

        $.each(data, function(key, value) {
            fd.append(key, value);
        });

        return fd;
    }

    function get(uri) {
        return request({
            method: 'GET',
            uri: uri,
            args: {
                dataType: 'text',
                accepts: {
                    text: "application/json",
                }
            }
        });
    }

    function put(data, uri) {

        return request({
            method: 'PUT',
            uri: uri,
            args: {
                data: _fd(data)
            }
        });
    }

    function post(data, uri) {

        return request({
            method: 'POST',
            uri: uri,
            args: {
                data: _fd(data)
            }
        });
    }

    // paste

    function paste_delete(uuid) {

        return request({
            method: 'DELETE',
            uri: uuid
        });
    }

    // url

    function url_post(data) {

        return post(data, 'u');
    }

    //

    return {
        paste: {
            post: post,
            put: put,
            delete: paste_delete,
            get: get,
        },
        url: {
            post: url_post
        },
    }
});


var WWW = (function(undefined) {

    function init() {
        $('#datetime').datetimepicker({
            icons: {
                time: 'fa fa-clock-o',
                date: 'fa fa-calendar',
                up: 'fa fa-chevron-up',
                down: 'fa fa-chevron-down',
                previous: 'fa fa-chevron-left',
                next: 'fa fa-chevron-right',
                today: 'fa fa-compass',
                clear: 'fa fa-trash',
                close: 'fa fa-remove'
            },
        });
    }

    function alert_new() {

        var alert = $('#stash').find('.alert').clone();
        var target = $('#alert-col');

        target.append(alert);

        return { title: function (title, message, link) {
            var title, strong;
            if (link !== undefined)
                message = $('<a>')
                .attr('href', link)
                .text(message);

            strong = $('<strong>').text(title);
            title = $('<div>').append(strong).append(': ').append(message);

            return alert.append(title);
        }}
    }

    function clear() {

        $('input').val('');
        $('textarea').val('');

        $('#content').removeClass('hidden');
        $('#filename').addClass('hidden');

        $('input, button').not('.ignore-disable').prop('disabled', false);
    }

    function select_file() {

        var filename = $('#file-input').prop('files')[0].name;

        $('#content').addClass('hidden');
        $('#filename').removeClass('hidden')
            .children().text(filename);

        $('#shorturl').prop('disabled', true);
    }

    function paste_data(content_only) {

        if (!$('#password').val()) {
            return;
        }

        var content, fd = new FormData();

        // hmm, could support multiple file uploads at once
        content = encrypt($('#content').val(), $('#password').val());
        fd.append('content', content);

        if (content_only == true)
            return fd;

        /* always use private pastes */
        fd.append('private', 1);

        $('.api-input:text:enabled').each(function() {
            var value = $(this).val(),
                name = $(this).attr('name');

            if (value)
                fd.append(name, value);
        });

        return fd;
    }

    var status_keys = ['status', 'uuid', 'sunset', 'error'];

    function api_status(data) {

        if (!Object.prototype.isPrototypeOf(data))
            return;

        var alert = alert_new();

        $.each(status_keys, function(index, key) {
            var title,
                value = data[key];

            if (value === undefined)
                return;

            if (key == 'status')
                alert.title(key, value, data.url);
            else
                alert.title(key, value);
        });
    }

    function set_uuid(data) {

        var uuid = data.uuid;

        if (uuid === undefined)
            return;

        $('#uuid').val(uuid);
    }

    function set_content(data, xhr) {

        var ct = xhr.getResponseHeader('content-type')
        if (ct.startsWith("text/")) {
            $('#content').val(data);
        } else {
            alert_new().title('status', 'cowardly refusing to display C-T: ' + ct);
        }
    }

    function url_data() {

        return {
            content: $('#content').val()
        }
    }

    function swap_sunset() {
        var sunset = $('#sunset'),
            hidden = sunset.find('input, span.fa'),
            visible = hidden.not('.hidden');

        hidden.removeClass('hidden').prop('disabled', false);
        visible.addClass('hidden').prop('disabled', true);
    }

    return {
        alert: alert,
        clear: clear,
        select_file: select_file,
        paste_data: paste_data,
        url_data: url_data,
        api_status: api_status,
        set_uuid: set_uuid,
        set_content: set_content,
        swap_sunset: swap_sunset,
        init: init
    };
});

$(function() {

    var api = API('https://ptpb.pw/');
    var app = WWW();

    function paste_submit(event) {
        if (!$('#password').val()) {
            return;
        }

        var e = $(event.target),
            fd = app.paste_data(),
            fn = api.paste[e.data('method')];

        return fn(fd, e.uri()).done(function(data) {
            app.set_uuid(data);
        });
    }

    function try_json(xhr) {
        if (xhr.responseJSON !== undefined)
            return xhr.responseJSON;
        try {
            return $.parseJSON(xhr.responseText);
        } catch(err) {
            return {}
        }
    }

    var _xhr = $.ajaxSettings.xhr;
    $.ajaxSettings.xhr = function() {
        var res = _xhr();
        res.upload.addEventListener('progress', function(event) {
            $('.progress-bar').width(event.loaded / event.total * 100 + "%");
        });
        return res;
    }

    $.fn.extend({
        click: function(fn) {
            if (arguments.length == 0)
                return $(this).trigger('click');
	    $(this).on('click', function(event) {
                event.preventDefault();
                fn(event);
                event.target.blur();
            });
        },
        sclick: function(fn) {
            $(this).click(function(event) {
                var spinner = $(event.target).find('.fa-spinner'),
                    progress = $('.progress');
                spinner.removeClass('hidden');
                progress.removeClass('hidden');

                fn(event).always(function() {
                    spinner.addClass('hidden');
                    progress.addClass('hidden');
                    $('.progress-bar').width('0%');
                }).done(function(data) {
                    app.api_status(data);
                }).fail(function(xhr, status, error) {
                    var s = try_json(xhr);
                    console.log(xhr);
                    s[status] = error;
                    app.api_status(s);
                });
            });
        },
        uri: function(value) {
            uri = $(this).data('uri');
            if (uri !== undefined) {
                if (arguments.length != 0)
                    return $(uri).val(value);
                return $(uri).val();
            }
        }
    });

    function getCipherText (url) {
      xhr = new XMLHttpRequest();
      xhr.open('GET', url, false);
      xhr.send();

      return xhr.responseText;
    }

    app.clear();

    var matches = document.URL.match(/https?:\/\/.*\/(.*)/);
    if (matches[1].length > 0) {

        var sourceURL = matches[1];

        if (!sourceURL.match(/https?:\/\/.*/)) {
          sourceURL = 'https://ptpb.pw/' + sourceURL;
        }

        var ciphertext = getCipherText(sourceURL);
        $('#content').val(ciphertext);
        $('#content').addClass('blurry-text');

        var passwd = prompt("Enter password:", "");
        $('#password').val(passwd);

        $('#content').val(decrypt(ciphertext, passwd));
        $('#content').removeClass('blurry-text');
    }

    $('#paste').addClass('disabled', true);
    $('#password').keyup(function () {
        $('#paste').removeClass('disabled', (this.value === ""));
    });

    $('#clear').click(function(event) {
        app.clear();
        $("#content").focus();
    });

    $('#file-input').change(function(event) {
        app.select_file();
    });

    $('#file').click(function(event) {
        $('#file-input').click();
    });

    $('#shorturl').sclick(function(event) {
        var fd = app.url_data();

        return api.url.post(fd);
    });

    $('#paste').sclick(paste_submit);
    $('#update').sclick(paste_submit);

    $('#delete').sclick(function(event) {
        var e = $(event.target)
        return api.paste.delete(e.uri()).done(function(data) {
            e.uri('');
        });
    });

    $('#load').sclick(function(event) {
        var e = $(event.target)
        return api.paste.get(e.uri()).done(function(data, status, xhr) {
            app.set_content(data, xhr);
        });
    });

    $('#paste-form').submit(function(event) {
        event.preventDefault();
    });

    $('#swap').click(app.swap_sunset);

    app.init();

    // refresh on firefox doesn't clear form values, but does clear
    // element state; whut
});
</script>

    <style id="index-style">input[type=checkbox]:checked ~ label {
    color: #333;
    background-color: #E6E6E6;
    border-color: #ADADAD;
}

</style>
  </head>
  <body>
    <div id="stash" class="hidden" aria-hidden="true">
      <div class="alert alert-info fade in" role="alert">
        <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&#215;</span></button>
      </div>
    </div>

    <div class="navbar-fixed-top">
      <div class="progress hidden">
        <div class="progress-bar progress-bar-info" role="progressbar" aria-valuemin="0" aria-valuemax="100">
        </div>
      </div>
    </div>

    <div class="container">
      <div class="row">
        <div class="col-md-12">
          <div class="text-center">
            <h1 class="page-header"><a href="https://sptpb.pw/" target="_self">sptpb.pw</a></h1>
            <h3>A website to securely paste shit</h3>
            <p class="lead small">Built atop <a href="https://ptpb.pw/f">ptpb.pw</a>, thanks you</p>
          </div>
        </div>

        <form id="paste-form" enctype="multipart/form-data" method="POST" action="/">
          <div id="alert-col" class="col-sm-12">

          </div>
          <div class="col-sm-12 form-group">
            <textarea id="content" name="content" class="form-control paste-content" autofocus="autofocus"></textarea>
            <div id="filename" class="hidden well text-center"><h4></h4></div>
          </div>

          <div class="col-xs-6 col-sm-6 form-inline form-group">
            <div class="form-group">
              <div class="input-group">
                <input id="password" class="form-control" placeholder="password" disabled>
                <div class="input-group-btn">
                  <button id="paste" type="submit" class="btn btn-primary btn-block" data-method="post">
                    Paste
                    <span class="fa fa-spin fa-spinner hidden"></span>
                  </button>
                </div>
              </div>
            </div>

            <!-- id=file, type=submit continer div id=file-input -->
            <!-- id=shorturl, type=submit formaction=/u continer div id=file-input -->

          </div>

          <div class="col-xs-6 col-sm-6 form-inline form-group text-right">
            <div class="form-group">
              <button id="clear" type="reset" class="btn btn-default btn-block">Clear</button>
            </div>
          </div>

          <div class="col-xs-6 col-sm-6 col-sm-push-6 form-group">
            <div class="form-group">
              <label for="sunset" class="sr-only">Expires</label>
              <div class="input-group" id="sunset">
                <input type="text" class="form-control api-input" id="datetime" name="sunset" placeholder="Expires">
                <input type="text" class="form-control api-input hidden ignore-disable" name="sunset" placeholder="Expires (seconds)" disabled>
                <span id="swap" class="input-group-addon">
                  <span class="fa fa-calendar"></span>
                  <span class="fa fa-clock-o hidden"></span>
                </span>
              </div>
            </div>
            <div class="form-group">
              <label for="label" class="sr-only">Label</label>
              <input type="text" id="label" class="form-control" placeholder="Label" disabled>
            </div>
          </div>

          <div class="col-xs-12 col-sm-6 col-sm-pull-6 form-inline form-group">
            <div class="form-group">
              <div class="input-group">
                <input id="pasteid" class="form-control" placeholder="paste ID" disabled>
                <div class="input-group-btn">
                  <button id="load" type="submit" class="btn btn-default" data-uri="#pasteid" disabled>Load
                    <span class="fa fa-spin fa-spinner hidden"></span>
                  </button>
                </div>
              </div>
            </div>
          </div>

          <div class="col-xs-12 col-sm-6 col-sm-pull-6 form-inline form-group">
            <div class="form-group">
              <div class="input-group">
                <input id="uuid" class="form-control" placeholder="paste UUID" disabled>
                <div class="input-group-btn">
                  <button id="update" type="submit" class="btn btn-default" data-uri="#uuid" data-method="put" disabled>
                    Update
                    <span class="fa fa-spin fa-spinner hidden"></span>
                  </button>
                </div>
                <div class="input-group-btn">
                  <button id="delete" type="submit" class="btn btn-default" data-uri="#uuid" data-method="delete" disabled>
                    Delete
                    <span class="fa fa-spin fa-spinner hidden"></span>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </form>
      </div>

      <footer class="footer">
        <div class="container">
          <p class="text-muted text-center small">Send all complaints to <a href="https://github.com/syntactician/spb" target="_self">syntactician & qguv</a></p>
        </div>
      </footer>
    </div>
  </body>
</html>
